{{- if .Values.rbac.create -}}
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "kubestellar-console.fullname" . }}
  labels:
    {{- include "kubestellar-console.labels" . | nindent 4 }}
rules:
  # Core v1 - read-only (secrets explicitly excluded)
  - apiGroups: [""]
    resources:
      - nodes
      - pods
      - pods/log
      - services
      - events
      - configmaps
      - serviceaccounts
      - persistentvolumeclaims
      - persistentvolumes
      - limitranges
      - namespaces
    verbs: ["get", "list", "watch"]

  # ResourceQuotas - full CRUD for GPU reservation enforcement
  - apiGroups: [""]
    resources:
      - resourcequotas
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # Apps v1 - read-only
  - apiGroups: ["apps"]
    resources:
      - deployments
      - replicasets
      - statefulsets
      - daemonsets
    verbs: ["get", "list", "watch"]

  # Batch v1 - read-only
  - apiGroups: ["batch"]
    resources:
      - jobs
      - cronjobs
    verbs: ["get", "list", "watch"]

  # Networking v1 - read-only
  - apiGroups: ["networking.k8s.io"]
    resources:
      - ingresses
      - networkpolicies
    verbs: ["get", "list", "watch"]

  # Autoscaling v2 - read-only
  - apiGroups: ["autoscaling"]
    resources:
      - horizontalpodautoscalers
    verbs: ["get", "list", "watch"]

  # RBAC v1 - read-only (for RBAC analysis features)
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources:
      - roles
      - clusterroles
      - rolebindings
      - clusterrolebindings
    verbs: ["get", "list", "watch"]

  # Authorization - permission checks
  - apiGroups: ["authorization.k8s.io"]
    resources:
      - selfsubjectaccessreviews
    verbs: ["create"]

  # Policy v1 - read-only
  - apiGroups: ["policy"]
    resources:
      - poddisruptionbudgets
    verbs: ["get", "list", "watch"]

  # API Extensions - read-only (CRD discovery)
  - apiGroups: ["apiextensions.k8s.io"]
    resources:
      - customresourcedefinitions
    verbs: ["get", "list", "watch"]

  # Admission registration - read-only
  - apiGroups: ["admissionregistration.k8s.io"]
    resources:
      - validatingwebhookconfigurations
      - mutatingwebhookconfigurations
    verbs: ["get", "list", "watch"]

  # NVIDIA GPU Operator - read-only
  - apiGroups: ["nvidia.com"]
    resources:
      - clusterpolicies
    verbs: ["get", "list", "watch"]

  # Mellanox Network Operator - read-only
  - apiGroups: ["mellanox.com"]
    resources:
      - nicclusterpolicies
    verbs: ["get", "list", "watch"]

  # Kagenti - read-only
  - apiGroups: ["agent.kagenti.dev"]
    resources:
      - agents
      - agentbuilds
      - agentcards
    verbs: ["get", "list", "watch"]
  - apiGroups: ["mcp.kagenti.com"]
    resources:
      - mcpservers
    verbs: ["get", "list", "watch"]

  # Console CRDs - full CRUD
  - apiGroups: ["console.kubestellar.io"]
    resources:
      - managedworkloads
      - managedworkloads/status
      - clustergroups
      - clustergroups/status
      - workloaddeployments
      - workloaddeployments/status
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

  # Gateway API - read-only
  - apiGroups: ["gateway.networking.k8s.io"]
    resources:
      - gateways
      - httproutes
    verbs: ["get", "list", "watch"]

  # Multi-cluster services - read-only
  - apiGroups: ["multicluster.x-k8s.io"]
    resources:
      - serviceexports
      - serviceimports
    verbs: ["get", "list", "watch"]

  # OpenShift user API - read-only
  - apiGroups: ["user.openshift.io"]
    resources:
      - users
    verbs: ["get", "list", "watch"]
{{- end }}
