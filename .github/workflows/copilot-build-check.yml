name: Copilot Build & Lint Check
# Runs build and lint on every push to copilot/* branches.
# If it fails, posts a comment telling Copilot to fix it.

on:
  push:
    branches:
      - 'copilot/**'

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write

jobs:
  build-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Build
        id: build
        working-directory: web
        run: npm run build 2>&1 | tee /tmp/build-output.txt
        continue-on-error: true

      - name: Lint
        id: lint
        working-directory: web
        run: npm run lint 2>&1 | tee /tmp/lint-output.txt
        continue-on-error: true

      - name: Find PR for this branch
        id: find_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          PR_NUM=$(gh pr list --repo "${{ github.repository }}" \
            --head "$BRANCH" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT

      - name: Override DCO for Copilot
        if: steps.find_pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.find_pr.outputs.pr_number }}"
          SHA="${{ github.sha }}"

          # Set DCO status to success
          gh api repos/${{ github.repository }}/statuses/$SHA \
            -f state=success \
            -f context=dco \
            -f description="DCO waived for Copilot" \
            -f target_url="https://github.com/kubestellar/console/blob/master/CONTRIBUTING.md"

          # Fix labels
          gh pr edit "$PR_NUM" --repo "${{ github.repository }}" \
            --remove-label "dco-signoff: no" 2>/dev/null || true
          gh pr edit "$PR_NUM" --repo "${{ github.repository }}" \
            --add-label "dco-signoff: yes" 2>/dev/null || true

          echo "DCO overridden for Copilot PR #$PR_NUM"

      - name: Comment on PR with failure details
        if: (steps.build.outcome == 'failure' || steps.lint.outcome == 'failure') && steps.find_pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.find_pr.outputs.pr_number }}"
          BUILD_STATUS="${{ steps.build.outcome }}"
          LINT_STATUS="${{ steps.lint.outcome }}"

          # Build the message
          MSG="## ❌ Build/Lint Failed\n\n@copilot Your latest push failed verification.\n\n"

          if [ "$BUILD_STATUS" == "failure" ]; then
            BUILD_LOG=$(tail -30 /tmp/build-output.txt)
            MSG="${MSG}### Build: FAILED\n\`\`\`\n${BUILD_LOG}\n\`\`\`\n\n"
          else
            MSG="${MSG}### Build: Passed ✅\n\n"
          fi

          if [ "$LINT_STATUS" == "failure" ]; then
            LINT_LOG=$(tail -30 /tmp/lint-output.txt)
            MSG="${MSG}### Lint: FAILED\n\`\`\`\n${LINT_LOG}\n\`\`\`\n\n"
          else
            MSG="${MSG}### Lint: Passed ✅\n\n"
          fi

          MSG="${MSG}**Fix these errors and push again.** Do not mark this PR as ready until both pass."

          gh pr comment "$PR_NUM" --repo "${{ github.repository }}" --body "$(echo -e "$MSG")"
          echo "Posted build/lint failure comment on PR #$PR_NUM"

      - name: Mark PR ready when build and lint pass
        if: steps.build.outcome == 'success' && steps.lint.outcome == 'success' && steps.find_pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.find_pr.outputs.pr_number }}"

          # Check if PR is draft
          IS_DRAFT=$(gh pr view "$PR_NUM" --repo "${{ github.repository }}" --json isDraft --jq '.isDraft')
          if [ "$IS_DRAFT" = "true" ]; then
            gh pr ready "$PR_NUM" --repo "${{ github.repository }}"
            echo "Marked PR #$PR_NUM as ready for review"
          fi

          # Remove WIP from title
          TITLE=$(gh pr view "$PR_NUM" --repo "${{ github.repository }}" --json title --jq '.title')
          if echo "$TITLE" | grep -q '\[WIP\]'; then
            NEW_TITLE=$(echo "$TITLE" | sed 's/\[WIP\] *//')
            gh pr edit "$PR_NUM" --repo "${{ github.repository }}" --title "$NEW_TITLE"
            echo "Removed [WIP] from title"
          fi

          # Clean up labels
          gh pr edit "$PR_NUM" --repo "${{ github.repository }}" \
            --remove-label "do-not-merge/work-in-progress" 2>/dev/null || true

          echo "PR #$PR_NUM is ready: build and lint passed"

      - name: Fail the check if build or lint failed
        if: steps.build.outcome == 'failure' || steps.lint.outcome == 'failure'
        run: |
          echo "Build: ${{ steps.build.outcome }}, Lint: ${{ steps.lint.outcome }}"
          exit 1
