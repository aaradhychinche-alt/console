name: Copilot Build Monitor

on:
  check_run:
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write

jobs:
  handle-build-failure:
    runs-on: ubuntu-latest
    if: |
      github.event.check_run.conclusion == 'failure' &&
      contains(github.event.check_run.name, 'netlify')
    steps:
      - name: Handle Netlify Failure
        uses: actions/github-script@v7
        with:
          script: |
            const prs = context.payload.check_run.pull_requests;
            if (!prs || prs.length === 0) {
              core.info('No PRs for this check run');
              return;
            }

            const prNumber = prs[0].number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const author = pr.user.login;
            const isCopilot = author === 'Copilot' ||
                              author.toLowerCase().includes('copilot');

            if (!isCopilot) {
              core.info(`PR #${prNumber} not from Copilot`);
              return;
            }

            core.info(`Build failed for Copilot PR #${prNumber}`);
            const headSha = pr.head.sha;

            // 1. Override DCO for new commits
            try {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: headSha,
                state: 'success',
                context: 'dco',
                description: 'DCO waived for Copilot'
              });
              core.info('DCO overridden');
            } catch (e) { /* ignore */ }

            // 2. Fix DCO labels
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                name: 'dco-signoff: no'
              });
            } catch (e) { /* ignore */ }

            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['dco-signoff: yes']
              });
            } catch (e) { /* ignore */ }

            // 3. Check for recent notification for THIS commit
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 10
            });

            // Only skip if we already notified about THIS specific commit
            const notifiedThisCommit = comments.find(c =>
              c.body.includes('Build Failed') &&
              c.body.includes('@Copilot') &&
              c.body.includes(headSha.substring(0, 7))
            );

            if (notifiedThisCommit) {
              core.info('Already notified for this commit');
              return;
            }

            // 4. Count how many build failures we've had
            const failureCount = comments.filter(c =>
              c.body.includes('Build Failed') &&
              c.body.includes('@Copilot')
            ).length;

            // 5. Analyze the diff to provide specific guidance
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            let guidance = '';
            const tsFiles = files.filter(f => f.filename.endsWith('.ts') || f.filename.endsWith('.tsx'));
            if (tsFiles.length > 0) {
              guidance = `\n\n**Files changed:** ${tsFiles.map(f => f.filename).join(', ')}\n\nCommon TypeScript fixes:\n- Undefined function? Check if it exists or define it\n- Type error? Add proper type annotations\n- Unused import? Remove it`;
            }

            // 6. Escalate message based on failure count
            let urgency = '';
            if (failureCount >= 3) {
              urgency = '\n\n**This is attempt #' + (failureCount + 1) + '.** Please carefully review the build logs and fix the root cause.';
            }

            const url = context.payload.check_run.details_url || '';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## Build Failed (commit ${headSha.substring(0, 7)})\n\n@Copilot The Netlify build failed. Please check the logs and fix the error.\n\n**Build logs:** ${url}${guidance}${urgency}`
            });
            core.info('Posted notification');

            // 7. Add ai-stuck label if too many failures
            if (failureCount >= 5) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: ['ai-stuck']
                });
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `## Needs Human Help\n\n@clubanderson This PR has had ${failureCount + 1} build failures. Copilot may need human assistance to resolve the issue.`
                });
              } catch (e) { /* ignore */ }
            }
